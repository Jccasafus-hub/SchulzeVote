<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Votar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f8fafc}
    .wrap{max-width:820px;margin:0 auto;padding:24px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:18px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{display:block;margin:10px 0 6px}
    input[type=text], input[type=password], input[type=number]{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #e5e7eb;padding:8px;text-align:left}
    th{background:#f3f4f6}
    .muted{color:#6b7280}
    .notice{background:#ecfeff;border:1px solid #bae6fd;padding:10px;border-radius:10px;margin:10px 0}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #111827;background:#111827;color:#fff;cursor:pointer}
    .btn.ghost{background:#fff;color:#111827;border:1px dashed #9ca3af}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Votação</h1>

    <!-- mensagens flash -->
    <div class="msgs">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="msg {{category}}">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>

    <div class="card">
      <form method="post" action="{{ url_for('vote') }}" id="voteForm">
        <!-- CHAVE (com mostrar/ocultar) -->
        <label for="voter_id">Chave de votação</label>
        <div class="row" style="gap:12px">
          <input id="voter_id" name="voter_id" type="password" required placeholder="Ex.: ABCD-1234-EFGH" style="flex:1;min-width:240px" inputmode="latin-prose" autocomplete="one-time-code">
          <label class="muted" style="display:flex;align-items:center;gap:6px;">
            <input type="checkbox" onclick="toggleVoterKey()"> Mostrar chave
          </label>
        </div>

        <div class="notice">
          <b>Como preencher:</b>
          informe um número de preferência para cada candidato que você quiser ordenar (1 = preferência mais alta).
          Você pode deixar alguns em branco (indiferença por eles).  
          Se desejar, você pode escolher <i>Voto em Branco</i> ou <i>Voto Nulo</i> — isso desabilita o ranqueamento.
        </div>

        <!-- ESPECIAIS: branco/nulo -->
        <fieldset style="border:none;padding:0;margin:12px 0">
          <legend class="muted" style="margin-bottom:6px">Alternativas especiais</legend>
          <label style="margin-right:16px">
            <input type="radio" name="special_vote" value="BLANK" onchange="onSpecialChange(this)">
            Voto em Branco
          </label>
          <label>
            <input type="radio" name="special_vote" value="NULL" onchange="onSpecialChange(this)">
            Voto Nulo
          </label>
          <div class="muted" style="margin-top:4px;font-size:.95rem">
            Se marcar uma dessas opções, os campos de ranqueamento serão desabilitados.
          </div>
        </fieldset>

        <!-- RANKEAMENTO NUMÉRICO (compatível com app.py) -->
        <table id="rankTable">
          <thead>
            <tr><th style="width:60%">Candidato</th><th style="width:40%">Preferência (número ≥ 1)</th></tr>
          </thead>
          <tbody>
            {% for c in candidates %}
              <tr>
                <td>{{ c }}</td>
                <td>
                  <!-- campos no formato que o app.py espera: pares cand_i / rank_i -->
                  <input type="hidden" name="cand_{{ loop.index0 }}" value="{{ c }}">
                  <input type="number" name="rank_{{ loop.index0 }}" min="1" step="1" inputmode="numeric" placeholder="deixe em branco se não quiser ranquear">
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <div class="row" style="margin-top:12px">
          <button type="submit" class="btn">Enviar voto</button>
          <a href="{{ url_for('index') }}" class="btn ghost">Início</a>
        </div>
      </form>
    </div>
  </div>

<script>
function toggleVoterKey(){
  const inp = document.getElementById('voter_id');
  if(!inp) return;
  inp.type = (inp.type === 'password') ? 'text' : 'password';
}

function onSpecialChange(radio){
  const table = document.getElementById('rankTable');
  const disabled = !!(radio && radio.checked);
  // Se escolheu uma especial, desabilita todos inputs de ranking
  const rbs = document.querySelectorAll('input[name="special_vote"]');
  const anySelected = Array.from(rbs).some(x=>x.checked);
  const inputs = table.querySelectorAll('input[type="number"]');
  inputs.forEach(inp=>{
    inp.disabled = anySelected;
    if (anySelected) inp.value = '';
  });
}

// Se desmarcar todas especiais (ex: clicando na selecionada de novo), reabilita:
document.querySelectorAll('input[name="special_vote"]').forEach(el=>{
  el.addEventListener('click', function(e){
    // permitir “desselecionar” clicando na mesma opção
    if (this.previousChecked){
      this.checked = false; // toggla
      this.previousChecked = false;
      // reabilita ranking
      const inputs = document.querySelectorAll('#rankTable input[type="number"]');
      inputs.forEach(inp=> inp.disabled = false);
    } else {
      // marcar e desmarcar as outras
      document.querySelectorAll('input[name="special_vote"]').forEach(o=>{
        if (o !== this) o.previousChecked = false;
      });
      this.previousChecked = this.checked;
      onSpecialChange(this);
    }
  });
});
</script>
</body>
</html>      <p><b>Atalho:</b> você pode marcar um destes e ignorar os números acima:</p>
      <label><input type="radio" name="special_vote" value="BLANK"> Votar em <b>Voto em Branco</b></label><br>
      <label><input type="radio" name="special_vote" value="NULL"> Votar em <b>Voto Nulo</b></label><br>
      <label><input type="radio" name="special_vote" value="" checked> Nenhum (usarei os números acima)</label>

      <br><br>
      <div class="actions">
        <button type="submit" class="button">Enviar voto</button>
        <button type="button" class="button-secondary" id="fillAllBtn">Preencher 1..N (tudo)</button>
        <button type="button" class="button-secondary" id="fillEmptyBtn">Preencher 1..N (somente vazios)</button>
        <button type="button" class="button-secondary" id="clearBtn" title="Zera todas as preferências e desmarca Branco/Nulo">
          Limpar tudo
        </button>
      </div>

      <div class="card" style="margin-top:14px;">
        <h3>Acompanhar (público)</h3>
        <div class="actions">
          <a class="button-secondary" href="{{ url_for('results') }}">Resultados da votação atual</a>
          <a class="button-secondary" href="/public/elections">Todas as votações</a>
        </div>
      </div>
    </form>
  </div>

  <script>
    const form = document.getElementById("voteForm");
    const rankInputs = Array.from(document.querySelectorAll(".rank-input"));
    const specialRadios = Array.from(document.querySelectorAll('input[name="special_vote"]'));
    const statusBox = document.getElementById("statusBox");
    const previewContent = document.getElementById("previewContent");
    const clearBtn = document.getElementById("clearBtn");
    const fillAllBtn = document.getElementById("fillAllBtn");
    const fillEmptyBtn = document.getElementById("fillEmptyBtn");

    function getRows() {
      const rows = [];
      for (let i = 0; ; i++) {
        const candEl = form.querySelector(`input[name="cand_${i}"]`);
        const rankEl = form.querySelector(`input[name="rank_${i}"]`);
        if (!candEl || !rankEl) break;
        rows.push({ cand: candEl.value, rankEl });
      }
      return rows;
    }

    function setDisabledRanks(disabled) {
      rankInputs.forEach(inp => { inp.disabled = disabled; if (disabled) inp.value = ""; });
      updateStatusAndPreview();
    }

    function updateSpecialMode() {
      const val = (specialRadios.find(r => r.checked) || {}).value || "";
      if (val === "BLANK" || val === "NULL") setDisabledRanks(true);
      else setDisabledRanks(false);
    }
    specialRadios.forEach(r => r.addEventListener("change", updateSpecialMode));

    function updateStatusAndPreview() {
      const val = (specialRadios.find(r => r.checked) || {}).value || "";
      if (val === "BLANK" || val === "NULL") {
        statusBox.innerHTML = '<span class="ok">Modo especial selecionado. Os campos numéricos foram desativados.</span>';
        const pick = (val === "BLANK") ? "Voto em Branco" : "Voto Nulo";
        previewContent.innerHTML = `<div class="tier"><b>Selecionado:</b>
          <span class="chip ${val === 'BLANK' ? 'special' : 'special-null'}">${pick}</span></div>`;
        return;
      }

      const rows = getRows();
      let total = rows.length, filled = 0;
      const groups = new Map(); const unranked = [];
      for (const {cand, rankEl} of rows) {
        const v = (rankEl.value || "").trim();
        if (v) { filled++; const g = groups.get(v) || []; g.push(cand); groups.set(v, g); }
        else { unranked.push(cand); }
      }
      const blanks = total - filled;
      statusBox.textContent = `Preenchidos: ${filled} • Em branco: ${blanks} • Empates permitidos (números iguais).`;

      const rankKeys = Array.from(groups.keys()).map(k=>Number(k)).filter(n=>Number.isFinite(n)&&n>=1).sort((a,b)=>a-b).map(n=>String(n));
      let html = "";
      for (const rk of rankKeys) {
        const items = groups.get(rk) || [];
        items.sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:"base"}));
        html += `<div class="tier"><b>#${rk}:</b> ` + items.map(c => chip(c)).join(" ") + `</div>`;
      }

      if (unranked.length > 0) {
        const hasBlank = unranked.includes("Voto em Branco");
        const hasNull  = unranked.includes("Voto Nulo");
        const core = unranked.filter(c => c!=="Voto em Branco" && c!=="Voto Nulo")
                             .sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:"base"}));
        let tail = []; if (hasBlank) tail.push("Voto em Branco"); if (hasNull) tail.push("Voto Nulo");
        const finalList = core.concat(tail);
        html += `<div class="tier"><b>Não ranqueados:</b> ` + finalList.map(c => chip(c)).join(" ") + `</div>`;
      }
      previewContent.innerHTML = html || `<span class="muted">Comece a preencher os números ou selecione Branco/Nulo.</span>`;
    }

    function chip(name) {
      if (name === "Voto em Branco") return `<span class="chip special">${name}</span>`;
      if (name === "Voto Nulo") return `<span class="chip special-null">${name}</span>`;
      return `<span class="chip">${name}</span>`;
    }

    function clearAll() {
      const ok = window.confirm("Tem certeza que deseja limpar todas as preferências e desmarcar Branco/Nulo?");
      if (!ok) return;
      rankInputs.forEach(inp => { inp.value = ""; inp.disabled = false; });
      const noneRadio = specialRadios.find(r => r.value === "");
      specialRadios.forEach(r => r.checked = false);
      if (noneRadio) noneRadio.checked = true;
      updateStatusAndPreview();
      if (rankInputs.length>0) rankInputs[0].focus();
    }

    function autoFillSequential(overwrite=true) {
      const rows = getRows();
      let n = 1;
      for (const {cand, rankEl} of rows) {
        if (cand === "Voto em Branco" || cand === "Voto Nulo") continue;
        if (rankEl.disabled) continue;
        if (overwrite || !rankEl.value.trim()) { rankEl.value = String(n++); }
      }
      updateStatusAndPreview();
    }

    clearBtn.addEventListener("click", clearAll);
    fillAllBtn.addEventListener("click", () => autoFillSequential(true));
    fillEmptyBtn.addEventListener("click", () => autoFillSequential(false));

    rankInputs.forEach(inp => inp.addEventListener("input", updateStatusAndPreview));
    updateSpecialMode(); updateStatusAndPreview();
  </script>
</body>
</html>
