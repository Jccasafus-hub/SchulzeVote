<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Votação - SchulzeVote</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .grid { display:grid; gap:10px; grid-template-columns: 1fr 120px; align-items:center; }
    .row { display:contents; }
    .hdr { font-weight:bold; }
    .special { background:#111827; color:#fff; padding:6px 10px; border-radius:6px; }
    .special-null { background:#991b1b; color:#fff; padding:6px 10px; border-radius:6px; }
    .muted { color:#6b7280; }
    .sep { margin:14px 0; border-top:1px solid #e5e7eb; }
    input[type="number"] { width:100%; padding:6px 8px; border:1px solid #d1d5db; border-radius:8px; }
    input[disabled] { background:#f3f4f6; }
    .info { margin-top:6px; }
    .ok { color:#059669; }
    .note { color:#374151; }
    .preview { margin-top:14px; border:1px solid #e5e7eb; border-radius:10px; padding:12px; background:#fafafa; }
    .preview h3 { margin:0 0 8px 0; font-size:1.05rem; }
    .tier { margin-bottom:8px; }
    .tier b { display:inline-block; min-width:64px; }
    .chip { display:inline-block; padding:4px 8px; margin:2px; background:#fff; border:1px solid #e5e7eb; border-radius:999px; }
    .chip.special { background:#111827; color:#fff; border-color:#111827; }
    .chip.special-null { background:#991b1b; color:#fff; border-color:#991b1b; }
    .actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .button { background:#111827; color:#fff; border:1px solid #111827; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .button-secondary { background:#fff; color:#111827; border:1px solid #d1d5db; padding:8px 12px; border-radius:8px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Votação</h1>

    <form method="POST" id="voteForm">
      <label for="voter_id"><b>Sua chave de votação</b></label><br>
      <input type="text" id="voter_id" name="voter_id" required><br><br>

      <p class="muted">
        Digite <b>1</b> para sua primeira preferência, <b>2</b> para a segunda, etc.
        Você pode usar <b>o mesmo número</b> para indicar <b>empate</b>.
        Se deixar em branco, o candidato ficará <b>não ranqueado</b> (empatado em último).
      </p>

      <div class="grid hdr">
        <div>Candidato</div>
        <div>Preferência</div>
      </div>

      <div id="candGrid" class="grid">
        {% for c in candidates %}
          {% set is_blank = (c == "Voto em Branco") %}
          {% set is_null = (c == "Voto Nulo") %}
          <div class="row">
            <div>
              {% if is_blank %}
                <span class="special">{{ c }}</span>
              {% elif is_null %}
                <span class="special-null">{{ c }}</span>
              {% else %}
                {{ c }}
              {% endif %}
              <input type="hidden" name="cand_{{ loop.index0 }}" value="{{ c }}">
            </div>
            <div>
              <input type="number" min="1" step="1" inputmode="numeric"
                     name="rank_{{ loop.index0 }}" class="rank-input"
                     data-candidate="{{ c }}">
            </div>
          </div>
        {% endfor %}
      </div>

      <div id="statusBox" class="info note"></div>

      <div class="preview" id="livePreview" aria-live="polite" aria-atomic="true">
        <h3>Pré-visualização da sua cédula</h3>
        <div id="previewContent" class="muted">Comece a preencher os números ou selecione Branco/Nulo.</div>
      </div>

      <div class="sep"></div>

      <p><b>Atalho:</b> você pode marcar um destes e ignorar os números acima:</p>
      <label><input type="radio" name="special_vote" value="BLANK"> Votar em <b>Voto em Branco</b></label><br>
      <label><input type="radio" name="special_vote" value="NULL"> Votar em <b>Voto Nulo</b></label><br>
      <label><input type="radio" name="special_vote" value="" checked> Nenhum (usarei os números acima)</label>

      <br><br>
      <div class="actions">
        <button type="submit" class="button">Enviar voto</button>
        <button type="button" class="button-secondary" id="fillAllBtn">Preencher 1..N (tudo)</button>
        <button type="button" class="button-secondary" id="fillEmptyBtn">Preencher 1..N (somente vazios)</button>
        <button type="button" class="button-secondary" id="clearBtn" title="Zera todas as preferências e desmarca Branco/Nulo">
          Limpar tudo
        </button>
      </div>

      <div class="card" style="margin-top:14px;">
        <h3>Acompanhar (público)</h3>
        <div class="actions">
          <a class="button-secondary" href="{{ url_for('results') }}">Resultados da votação atual</a>
          <a class="button-secondary" href="/public/elections">Todas as votações</a>
        </div>
      </div>
    </form>
  </div>

  <script>
    const form = document.getElementById("voteForm");
    const rankInputs = Array.from(document.querySelectorAll(".rank-input"));
    const specialRadios = Array.from(document.querySelectorAll('input[name="special_vote"]'));
    const statusBox = document.getElementById("statusBox");
    const previewContent = document.getElementById("previewContent");
    const clearBtn = document.getElementById("clearBtn");
    const fillAllBtn = document.getElementById("fillAllBtn");
    const fillEmptyBtn = document.getElementById("fillEmptyBtn");

    function getRows() {
      const rows = [];
      for (let i = 0; ; i++) {
        const candEl = form.querySelector(`input[name="cand_${i}"]`);
        const rankEl = form.querySelector(`input[name="rank_${i}"]`);
        if (!candEl || !rankEl) break;
        rows.push({ cand: candEl.value, rankEl });
      }
      return rows;
    }

    function setDisabledRanks(disabled) {
      rankInputs.forEach(inp => { inp.disabled = disabled; if (disabled) inp.value = ""; });
      updateStatusAndPreview();
    }

    function updateSpecialMode() {
      const val = (specialRadios.find(r => r.checked) || {}).value || "";
      if (val === "BLANK" || val === "NULL") setDisabledRanks(true);
      else setDisabledRanks(false);
    }
    specialRadios.forEach(r => r.addEventListener("change", updateSpecialMode));

    function updateStatusAndPreview() {
      const val = (specialRadios.find(r => r.checked) || {}).value || "";
      if (val === "BLANK" || val === "NULL") {
        statusBox.innerHTML = '<span class="ok">Modo especial selecionado. Os campos numéricos foram desativados.</span>';
        const pick = (val === "BLANK") ? "Voto em Branco" : "Voto Nulo";
        previewContent.innerHTML = `<div class="tier"><b>Selecionado:</b>
          <span class="chip ${val === 'BLANK' ? 'special' : 'special-null'}">${pick}</span></div>`;
        return;
      }

      const rows = getRows();
      let total = rows.length, filled = 0;
      const groups = new Map(); const unranked = [];
      for (const {cand, rankEl} of rows) {
        const v = (rankEl.value || "").trim();
        if (v) { filled++; const g = groups.get(v) || []; g.push(cand); groups.set(v, g); }
        else { unranked.push(cand); }
      }
      const blanks = total - filled;
      statusBox.textContent = `Preenchidos: ${filled} • Em branco: ${blanks} • Empates permitidos (números iguais).`;

      const rankKeys = Array.from(groups.keys()).map(k=>Number(k)).filter(n=>Number.isFinite(n)&&n>=1).sort((a,b)=>a-b).map(n=>String(n));
      let html = "";
      for (const rk of rankKeys) {
        const items = groups.get(rk) || [];
        items.sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:"base"}));
        html += `<div class="tier"><b>#${rk}:</b> ` + items.map(c => chip(c)).join(" ") + `</div>`;
      }

      if (unranked.length > 0) {
        const hasBlank = unranked.includes("Voto em Branco");
        const hasNull  = unranked.includes("Voto Nulo");
        const core = unranked.filter(c => c!=="Voto em Branco" && c!=="Voto Nulo")
                             .sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:"base"}));
        let tail = []; if (hasBlank) tail.push("Voto em Branco"); if (hasNull) tail.push("Voto Nulo");
        const finalList = core.concat(tail);
        html += `<div class="tier"><b>Não ranqueados:</b> ` + finalList.map(c => chip(c)).join(" ") + `</div>`;
      }
      previewContent.innerHTML = html || `<span class="muted">Comece a preencher os números ou selecione Branco/Nulo.</span>`;
    }

    function chip(name) {
      if (name === "Voto em Branco") return `<span class="chip special">${name}</span>`;
      if (name === "Voto Nulo") return `<span class="chip special-null">${name}</span>`;
      return `<span class="chip">${name}</span>`;
    }

    function clearAll() {
      const ok = window.confirm("Tem certeza que deseja limpar todas as preferências e desmarcar Branco/Nulo?");
      if (!ok) return;
      rankInputs.forEach(inp => { inp.value = ""; inp.disabled = false; });
      const noneRadio = specialRadios.find(r => r.value === "");
      specialRadios.forEach(r => r.checked = false);
      if (noneRadio) noneRadio.checked = true;
      updateStatusAndPreview();
      if (rankInputs.length>0) rankInputs[0].focus();
    }

    function autoFillSequential(overwrite=true) {
      const rows = getRows();
      let n = 1;
      for (const {cand, rankEl} of rows) {
        if (cand === "Voto em Branco" || cand === "Voto Nulo") continue;
        if (rankEl.disabled) continue;
        if (overwrite || !rankEl.value.trim()) { rankEl.value = String(n++); }
      }
      updateStatusAndPreview();
    }

    clearBtn.addEventListener("click", clearAll);
    fillAllBtn.addEventListener("click", () => autoFillSequential(true));
    fillEmptyBtn.addEventListener("click", () => autoFillSequential(false));

    rankInputs.forEach(inp => inp.addEventListener("input", updateStatusAndPreview));
    updateSpecialMode(); updateStatusAndPreview();
  </script>
</body>
</html>
