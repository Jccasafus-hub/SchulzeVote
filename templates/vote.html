<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Votação - SchulzeVote</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .candidate-list { list-style:none; padding:0; }
    .candidate-item { padding:10px; margin:6px 0; background:#f9fafb; border:1px solid #d1d5db; border-radius:6px; cursor:grab; }
    .special { background:#111827; color:white; text-align:center; }
    .special-null { background:#991b1b; color:white; text-align:center; }
    .disabled { opacity:0.5; pointer-events:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Votação</h1>

    <form method="POST">
      <label for="voter_id"><b>Sua chave de eleitor</b></label><br>
      <input type="text" id="voter_id" name="voter_id" required><br><br>

      <p>Arraste para ordenar os candidatos conforme sua preferência:</p>
      <ul id="sortable" class="candidate-list">
        {% for c in candidates %}
          {% if c == "Voto em Branco" %}
            <li class="candidate-item special" data-value="{{ c }}">{{ c }}</li>
          {% elif c == "Voto Nulo" %}
            <li class="candidate-item special-null" data-value="{{ c }}">{{ c }}</li>
          {% else %}
            <li class="candidate-item" data-value="{{ c }}">{{ c }}</li>
          {% endif %}
        {% endfor %}
      </ul>

      <!-- campo oculto que receberá a ordem final -->
      <div id="ranking-fields"></div>

      <button type="submit" class="button">Enviar voto</button>
    </form>
  </div>

  <script>
    const list = document.getElementById("sortable");
    const fields = document.getElementById("ranking-fields");

    // Função para atualizar os inputs hidden
    function updateHiddenFields() {
      fields.innerHTML = "";
      const items = list.querySelectorAll(".candidate-item");
      items.forEach(item => {
        const inp = document.createElement("input");
        inp.type = "hidden";
        inp.name = "ranking";
        inp.value = item.getAttribute("data-value");
        fields.appendChild(inp);
      });
    }

    // Drag and drop
    let dragSrc;
    list.addEventListener("dragstart", e => {
      dragSrc = e.target;
      e.dataTransfer.effectAllowed = "move";
    });
    list.addEventListener("dragover", e => {
      e.preventDefault();
      const target = e.target.closest(".candidate-item");
      if (target && target !== dragSrc) {
        list.insertBefore(dragSrc, target.nextSibling);
      }
    });
    list.addEventListener("drop", e => {
      e.preventDefault();
      updateHiddenFields();
    });

    // Marca os itens como draggable
    list.querySelectorAll(".candidate-item").forEach(li => {
      li.draggable = true;
    });

    // Regras: se Branco ou Nulo for selecionado, eles desativam os demais
    function enforceSpecialRules() {
      const items = Array.from(list.querySelectorAll(".candidate-item"));
      const hasBlank = items.find(it => it.getAttribute("data-value") === "Voto em Branco");
      const hasNull = items.find(it => it.getAttribute("data-value") === "Voto Nulo");

      let blankSelected = hasBlank && list.firstElementChild === hasBlank;
      let nullSelected = hasNull && list.firstElementChild === hasNull;

      if (blankSelected || nullSelected) {
        items.forEach(it => {
          if (it !== list.firstElementChild) it.classList.add("disabled");
        });
      } else {
        items.forEach(it => it.classList.remove("disabled"));
      }
    }

    list.addEventListener("drop", enforceSpecialRules);
    list.addEventListener("dragend", enforceSpecialRules);

    // Inicializa campos hidden e regras
    updateHiddenFields();
    enforceSpecialRules();
  </script>
</body>
</html>
